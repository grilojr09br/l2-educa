name: Deployment Status

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  status:
    name: ğŸ“Š Deployment Status Overview
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect changes
        id: changes
        run: |
          # Check what changed
          FRONTEND_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^l2-educa/' | grep -v '^l2-educa/DOCS/' || echo "")
          BACKEND_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^l2-educa-backend/' || echo "")
          DOCS_ONLY=$(git diff --name-only HEAD^ HEAD | grep -E '\.md$|^DOCS/|^l2-educa/DOCS/' || echo "")
          
          echo "frontend_changed=$( [ -n "$FRONTEND_CHANGED" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "backend_changed=$( [ -n "$BACKEND_CHANGED" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "docs_only=$( [ -z "$FRONTEND_CHANGED" ] && [ -z "$BACKEND_CHANGED" ] && [ -n "$DOCS_ONLY" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ L2 EDUCA - DEPLOYMENT STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ steps.changes.outputs.frontend_changed }}" == "true" ]; then
            echo "ğŸ¨ FRONTEND (l2-educa)"
            echo "   Status: âœ… Changes detected"
            echo "   Action: Build triggered â†’ Manual Hostinger deployment needed"
            echo "   URL: https://silviosuperandolimites.com.br/l2"
            echo "   ğŸ“¦ Run 'deploy-hostinger.bat' to deploy"
            echo ""
          fi
          
          if [ "${{ steps.changes.outputs.backend_changed }}" == "true" ]; then
            echo "ğŸ”§ BACKEND (l2-educa-backend)"
            echo "   Status: âœ… Changes detected"
            echo "   Action: Railway auto-deploying..."
            echo "   URL: https://l2-educa-backend-production.up.railway.app"
            echo "   ğŸš‚ Automatic deployment via Railway"
            echo ""
          fi
          
          if [ "${{ steps.changes.outputs.docs_only }}" == "true" ]; then
            echo "ğŸ“š DOCUMENTATION ONLY"
            echo "   Status: âœ… Documentation updated"
            echo "   Action: No deployment needed"
            echo ""
          fi
          
          if [ "${{ steps.changes.outputs.frontend_changed }}" == "false" ] && [ "${{ steps.changes.outputs.backend_changed }}" == "false" ] && [ "${{ steps.changes.outputs.docs_only }}" == "false" ]; then
            echo "â„¹ï¸  OTHER CHANGES"
            echo "   Status: âœ… Changes pushed"
            echo "   Action: Review changes manually"
            echo ""
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ View deployments: https://github.com/${{ github.repository }}/deployments"
          echo "ğŸ“ View actions: https://github.com/${{ github.repository }}/actions"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ’¬ Comment deployment instructions (frontend only)
        if: steps.changes.outputs.frontend_changed == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            // Only comment if this is a recent push
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 1
            });
            
            const commit = commits.data[0];
            const commitAge = Date.now() - new Date(commit.commit.author.date);
            
            // Only comment on commits less than 5 minutes old
            if (commitAge < 5 * 60 * 1000) {
              github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `ğŸ¨ **Frontend changes detected!**\n\n` +
                      `âœ… Build successful\n` +
                      `âš ï¸ **Manual deployment required**\n\n` +
                      `**To deploy to Hostinger:**\n` +
                      `\`\`\`bash\n` +
                      `deploy-hostinger.bat\n` +
                      `\`\`\`\n\n` +
                      `ğŸŒ Production URL: https://silviosuperandolimites.com.br/l2\n` +
                      `ğŸ“Š [View Deployments](https://github.com/${context.repo.owner}/${context.repo.repo}/deployments)`
              });
            }

