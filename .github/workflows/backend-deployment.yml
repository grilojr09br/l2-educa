name: Backend Deployment (Railway)

on:
  push:
    branches:
      - main
    paths:
      - 'l2-educa-backend/**'
      - 'railway.json'
      - 'nixpacks.toml'

  workflow_dispatch:

jobs:
  build-and-track:
    name: Build & Track Backend Deployment
    runs-on: ubuntu-latest
    
    environment:
      name: production-backend
      url: https://l2-educa-backend-production.up.railway.app

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: l2-educa-backend/package-lock.json

      - name: ðŸ”§ Install dependencies
        working-directory: l2-educa-backend
        run: npm ci --production=false

      - name: ðŸ—ï¸ Build backend
        working-directory: l2-educa-backend
        run: npm run build

      - name: âœ… Build successful
        run: |
          echo "âœ… Backend built successfully!"
          echo "ðŸ“¦ Build output: $(du -sh l2-educa-backend/dist | cut -f1)"
          echo "ðŸ“ Files: $(find l2-educa-backend/dist -type f | wc -l)"

      - name: ðŸ“Š Deployment info
        run: |
          echo "ðŸš€ Deployment Target: Railway"
          echo "ðŸŒ URL: https://l2-educa-backend-production.up.railway.app"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "âœ… Railway will auto-deploy this commit"

      - name: ðŸ’¾ Upload build artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-${{ github.sha }}
          path: l2-educa-backend/dist
          retention-days: 3

      - name: ðŸ“ Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production-backend',
              description: 'Backend deployment to Railway',
              auto_merge: false,
              required_contexts: [],
              production_environment: true
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'in_progress',
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Railway is deploying...',
              environment_url: 'https://l2-educa-backend-production.up.railway.app'
            });
            
            // Mark as success after a delay (Railway will handle actual deployment)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              log_url: 'https://railway.app',
              description: 'Deployed to Railway automatically',
              environment_url: 'https://l2-educa-backend-production.up.railway.app'
            });

      - name: ðŸŽ‰ Deployment tracked
        run: |
          echo "âœ… Deployment recorded in GitHub!"
          echo "ðŸš‚ Railway is handling the actual deployment"
          echo "View at: https://github.com/${{ github.repository }}/deployments"

