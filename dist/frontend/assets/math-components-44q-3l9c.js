var h=(f,e,t)=>new Promise((s,o)=>{var i=r=>{try{n(t.next(r))}catch(c){o(c)}},a=r=>{try{n(t.throw(r))}catch(c){o(c)}},n=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,a);n((t=t.apply(f,e)).next())});import{r as p,j as y,R as b}from"./react-vendor-DYggY1V5.js";class M{constructor(){this.errors=[],this.maxErrors=50,this.setupGlobalHandlers()}setupGlobalHandlers(){window.addEventListener("unhandledrejection",e=>{var t,s;console.error("ðŸš¨ Unhandled Promise Rejection:",e.reason),this.logError({type:"promise",message:((t=e.reason)==null?void 0:t.message)||"Unhandled promise rejection",stack:(s=e.reason)==null?void 0:s.stack,timestamp:new Date().toISOString()}),e.preventDefault()}),window.addEventListener("error",e=>{var t;console.error("ðŸš¨ Global Error:",e.error),this.logError({type:"global",message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:(t=e.error)==null?void 0:t.stack,timestamp:new Date().toISOString()})}),window.addEventListener("online",()=>{console.log("âœ… Network: Back online"),this.showNotification("ConexÃ£o restaurada","success")}),window.addEventListener("offline",()=>{console.warn("âš ï¸ Network: Offline"),this.showNotification("Sem conexÃ£o com a internet","warning")})}logError(e){this.errors.push(e),this.errors.length>this.maxErrors&&this.errors.shift()}getErrors(){return this.errors}clearErrors(){this.errors=[]}handleMathJaxError(e,t){console.error("âŒ MathJax Error:",e,"Formula:",t),this.logError({type:"mathjax",message:e.message,formula:t==null?void 0:t.substring(0,100),timestamp:new Date().toISOString()})}handleCacheError(e,t){console.error("âŒ Cache Error:",t,e),this.logError({type:"cache",operation:t,message:e.message,timestamp:new Date().toISOString()})}handleNavigationError(e,t){console.error("âŒ Navigation Error:",t,e),this.logError({type:"navigation",path:t,message:e.message,timestamp:new Date().toISOString()})}showNotification(e,t="info"){if(!("Notification"in window)){console.log(`ðŸ“¢ ${e}`);return}const s={success:"âœ…",warning:"âš ï¸",error:"âŒ",info:"â„¹ï¸"}[t]||"â„¹ï¸";console.log(`${s} ${e}`)}getStats(){const e={};return this.errors.forEach(t=>{e[t.type]=(e[t.type]||0)+1}),{total:this.errors.length,byType:e,recent:this.errors.slice(-5)}}}const d=new M,I="L2EducaDB",D=3,m="processedFormulas",E=100,x=0;class P{constructor(){this.db=null,this.memoryCache=new Map,this.currentPage=null,this.initPromise=this.init(),this.setupSessionCleanup()}setupSessionCleanup(){try{sessionStorage.getItem("l2educa_session")||(sessionStorage.setItem("l2educa_session",Date.now().toString()),this.clear().catch(t=>{d.handleCacheError(t,"setupSessionCleanup")})),this.currentPage=sessionStorage.getItem("l2educa_current_page")}catch(e){d.handleCacheError(e,"setupSessionCleanup")}}setCurrentPage(e){return h(this,null,function*(){try{this.currentPage&&this.currentPage!==e&&(yield this.clear(),this.memoryCache.clear()),this.currentPage=e,sessionStorage.setItem("l2educa_current_page",e)}catch(t){d.handleCacheError(t,"setCurrentPage")}})}init(){return h(this,null,function*(){return"indexedDB"in window?new Promise((e,t)=>{const s=indexedDB.open(I,D);s.onerror=()=>{const o=s.error;console.error("Failed to open IndexedDB:",o),d.handleCacheError(o,"init"),t(o)},s.onsuccess=()=>{this.db=s.result,this.cleanExpiredEntries(),e(!0)},s.onupgradeneeded=o=>{const i=o.target.result;i.objectStoreNames.contains(m)&&i.deleteObjectStore(m);const a=i.createObjectStore(m,{keyPath:"id"});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("lastAccess","lastAccess",{unique:!1}),a.createIndex("hitCount","hitCount",{unique:!1})}}):(console.warn("IndexedDB not available, using memory cache only"),!1)})}hash(e,t){let s=0;const o=`${t?"D":"I"}_${e}`;for(let i=0;i<o.length;i++){const a=o.charCodeAt(i);s=(s<<5)-s+a,s=s&s}return s.toString(36)}get(e,t){return h(this,null,function*(){const s=this.hash(e,t);return this.memoryCache.has(s)?this.memoryCache.get(s):(this.db||(yield this.initPromise.catch(()=>{})),this.db?new Promise(o=>{const a=this.db.transaction([m],"readwrite").objectStore(m),n=a.get(s);n.onsuccess=()=>{const r=n.result;if(!r){o(null);return}const c=Date.now()-r.timestamp,l=x*24*60*60*1e3;if(c>l){a.delete(s),o(null);return}r.hitCount++,r.lastAccess=Date.now(),a.put(r),this.memoryCache.set(s,r),o(r)},n.onerror=()=>{const r=n.error;console.error("Failed to get from IndexedDB:",r),d.handleCacheError(r,"get"),o(null)}}):null)})}set(e,t,s){return h(this,null,function*(){const o=this.hash(e,t),i={id:o,latex:e,html:s,display:t,timestamp:Date.now(),lastAccess:Date.now(),hitCount:1};if(this.memoryCache.set(o,i),this.db||(yield this.initPromise.catch(()=>{})),!!this.db)return new Promise(a=>{const r=this.db.transaction([m],"readwrite").objectStore(m),c=r.count();c.onsuccess=()=>h(this,null,function*(){c.result>=E&&(yield this.removeOldestEntry(r));const l=r.put(i);l.onsuccess=()=>a(!0),l.onerror=()=>{const u=l.error;console.error("Failed to store in IndexedDB:",u),d.handleCacheError(u,"set"),a(!1)}})})})}removeOldestEntry(e){return h(this,null,function*(){return new Promise(t=>{const o=e.index("lastAccess").openCursor(null,"next");let i=[];o.onsuccess=a=>{const n=a.target.result;n&&i.length<10?(i.push(n.primaryKey),n.continue()):(i.forEach(r=>e.delete(r)),t())},o.onerror=()=>{console.error("Failed to remove oldest entries:",o.error),t()}})})}cleanExpiredEntries(){return h(this,null,function*(){if(!this.db)return;const e=x*24*60*60*1e3,t=Date.now()-e;return new Promise(s=>{const i=this.db.transaction([m],"readwrite").objectStore(m),n=i.index("timestamp").openCursor(IDBKeyRange.upperBound(t));let r=0;n.onsuccess=c=>{const l=c.target.result;l?(i.delete(l.primaryKey),r++,l.continue()):s(r)},n.onerror=()=>{console.error("Failed to clean expired entries:",n.error),s(0)}})})}getStats(){return h(this,null,function*(){return this.db?new Promise(e=>{const o=this.db.transaction([m],"readonly").objectStore(m).count();o.onsuccess=()=>h(this,null,function*(){var r,c;const i=o.result,a=yield(c=(r=navigator.storage)==null?void 0:r.estimate)==null?void 0:c.call(r),n=(a==null?void 0:a.usage)||0;e({available:!0,entries:i,maxEntries:E,size:n,formattedSize:this.formatBytes(n)})}),o.onerror=()=>{e({available:!1,entries:0,size:0})}}):{available:!1,entries:0,size:0}})}formatBytes(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+s[o]}clear(){return h(this,null,function*(){if(this.memoryCache.clear(),!!this.db)return new Promise(e=>{const o=this.db.transaction([m],"readwrite").objectStore(m).clear();o.onsuccess=()=>{e(!0)},o.onerror=()=>e(!1)})})}logStats(){return h(this,null,function*(){})}}const S=new P,F=({children:f,formula:e,display:t=!1,className:s="",numbered:o=!1})=>{const i=p.useRef(null),[a,n]=p.useState(!1),r=e||f,c=p.useRef(r);p.useEffect(()=>{const u=i.current;!window.MathJax||!u||!r||(c.current!==r&&(c.current=r,n(!1)),a||h(null,null,function*(){const C=t?`\\[${r}\\]`:`\\(${r}\\)`;u.innerHTML=C,S.get(r,t).then(w=>{w&&w.html?(u.innerHTML=w.html,n(!0)):window.MathJax.typesetPromise([u]).then(()=>{S.set(r,t,u.innerHTML).catch(g=>{d.handleCacheError(g,"MathFormula-cache-set")}),n(!0)}).catch(g=>{console.error("MathJax typeset failed:",g),d.handleMathJaxError(g,r),n(!0)})}).catch(w=>{d.handleCacheError(w,"MathFormula-cache-get"),window.MathJax.typesetPromise([u]).then(()=>{n(!0)}).catch(g=>{console.error("MathJax typeset failed:",g),d.handleMathJaxError(g,r),n(!0)})})}))},[r,t,a]);const l=t?"div":"span";return y.jsx(l,{ref:i,className:`math-formula ${t?"display-mode":"inline-mode"} ${o?"numbered":""} ${s}`})},j=({children:f,formula:e})=>{const t=p.useRef(null),s=e||f;if(p.useEffect(()=>{window.MathJax&&t.current&&s&&window.MathJax.typesetPromise([t.current]).catch(n=>console.error("MathJax typeset failed:",n))},[s]),!s)return null;if(!(n=>typeof n=="string"&&n.includes("$"))(s))return y.jsx("span",{ref:t,className:"inline-formula-container",dangerouslySetInnerHTML:{__html:`\\(${s}\\)`}});const a=(n=>{if(!n)return[];if(typeof n!="string")return console.warn("InlineFormula: content is not a string",n),[{type:"text",content:String(n)}];const r=[];let c="",l=!1,u=0;for(;u<n.length;)n[u]==="$"?(l?(r.push({type:"math",content:c}),c="",l=!1):(c&&r.push({type:"text",content:c}),c="",l=!0),u++):(c+=n[u],u++);return c&&r.push({type:l?"math":"text",content:c}),r})(s);return!a||a.length===0?null:y.jsx("span",{ref:t,className:"inline-formula-container",children:a.map((n,r)=>n.type==="math"?y.jsx("span",{className:"math-part",dangerouslySetInnerHTML:{__html:`\\(${n.content}\\)`}},r):y.jsx("span",{className:"text-part",children:n.content},r))})},_=b.memo(j);export{_ as I,F as M,S as f};
