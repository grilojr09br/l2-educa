var V=Object.defineProperty,K=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var O=(s,o,t)=>o in s?V(s,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[o]=t,q=(s,o)=>{for(var t in o||(o={}))H.call(o,t)&&O(s,t,o[t]);if(M)for(var t of M(o))J.call(o,t)&&O(s,t,o[t]);return s},G=(s,o)=>K(s,L(o));var x=(s,o,t)=>new Promise((b,F)=>{var r=l=>{try{E(t.next(l))}catch(_){F(_)}},z=l=>{try{E(t.throw(l))}catch(_){F(_)}},E=l=>l.done?b(l.value):Promise.resolve(l.value).then(r,z);E((t=t.apply(s,o)).next())});import{r as f,j as e,u as W}from"./react-vendor-DYggY1V5.js";import{u as D,s as U,A as X}from"./page-forgotpassword-B2MfD6L6.js";import{G as Z,F as Q}from"./page-analyticgeometry-DYH9OuZI.js";import"./vendor-IcH3LwkJ.js";/* empty css                       */import"./math-components-44q-3l9c.js";const Y=({currentAvatar:s,onUploadSuccess:o})=>{const{user:t}=D(),[b,F]=f.useState(!1),[r,z]=f.useState(s),[E,l]=f.useState(null),[_,j]=f.useState(""),d=f.useRef(null),k={"image/jpeg":[255,216,255],"image/png":[137,80,78,71],"image/webp":[82,73,70,70],"image/gif":[71,73,70,56]},P=h=>x(null,null,function*(){return new Promise((g,i)=>{const u=new FileReader;u.onload=w=>{const y=new Uint8Array(w.target.result).subarray(0,8);for(const[v,a]of Object.entries(k))if(a.every((c,m)=>y[m]===c)){g({valid:!0,detectedType:v});return}i(new Error("Arquivo inv√°lido. Formato n√£o reconhecido como imagem."))},u.onerror=()=>i(new Error("Erro ao ler arquivo")),u.readAsArrayBuffer(h.slice(0,8))})}),N=(h,g=500)=>x(null,null,function*(){return new Promise((i,u)=>{const w=new FileReader;w.readAsDataURL(h),w.onload=y=>{const v=new Image;v.src=y.target.result,v.onload=()=>{const a=document.createElement("canvas"),c=h.size/1024>1024?600:400;let m=v.width,C=v.height;m>C?m>c&&(C*=c/m,m=c):C>c&&(m*=c/C,C=c),a.width=m,a.height=C;const A=a.getContext("2d");A.fillStyle="#FFFFFF",A.fillRect(0,0,m,C),A.drawImage(v,0,0,m,C);let I=.88;const B=()=>{a.toBlob(S=>{S?S.size/1024>g&&I>.6?(I-=.1,B()):i(S):u(new Error("Falha ao comprimir imagem"))},"image/jpeg",I)};B()},v.onerror=()=>u(new Error("Falha ao carregar imagem"))},w.onerror=()=>u(new Error("Falha ao ler arquivo"))})}),n=h=>x(null,null,function*(){var g;try{l(null),j("");const i=(g=h.target.files)==null?void 0:g[0];if(!i)return;if(!i.type.startsWith("image/")){l("Por favor, selecione uma imagem v√°lida");return}F(!0),j("üîç Validando arquivo..."),console.log("üîç Validando assinatura do arquivo...");try{yield P(i),console.log("‚úÖ Arquivo v√°lido")}catch(T){throw new Error(T.message)}j("üì¶ Comprimindo imagem..."),console.log("üì¶ Comprimindo imagem (frontend)...");const u=yield N(i);console.log("‚úÖ Compress√£o frontend completa:",{original:(i.size/1024).toFixed(2)+" KB",compressed:(u.size/1024).toFixed(2)+" KB",reduction:((1-u.size/i.size)*100).toFixed(1)+"%"}),j("üîê Processando com seguran√ßa..."),console.log("üîê Enviando para processamento backend...");const w=new FormData;w.append("image",u,"avatar.jpg");const{data:{session:y}}=yield U.auth.getSession();if(!(y!=null&&y.access_token))throw new Error("Sess√£o expirada. Fa√ßa login novamente.");const a=yield fetch("http://localhost:3001/api/images/optimize-avatar",{method:"POST",headers:{Authorization:`Bearer ${y.access_token}`},body:w});if(!a.ok){const T=yield a.json().catch(()=>({}));throw new Error(T.message||"Erro no processamento backend")}const p=yield a.blob(),c=a.headers.get("X-Reduction");console.log("‚úÖ Otimiza√ß√£o backend completa:",{finalSize:(p.size/1024).toFixed(2)+" KB",totalReduction:c||"N/A"}),j("‚òÅÔ∏è Enviando para nuvem..."),console.log("‚òÅÔ∏è Fazendo upload para Supabase...");const A=`${t.id}-${Date.now()}.jpg`,{data:I,error:B}=yield U.storage.from("avatars").upload(A,p,{contentType:"image/jpeg",upsert:!0,cacheControl:"3600"});if(B)throw B;const{data:{publicUrl:S}}=U.storage.from("avatars").getPublicUrl(A);console.log("‚úÖ Upload completo:",S),j("‚úÖ Conclu√≠do!"),z(S),o&&o(S)}catch(i){console.error("‚ùå Erro no upload:",i),l(i.message||"Erro ao fazer upload da imagem")}finally{F(!1),setTimeout(()=>j(""),3e3)}}),$=()=>{var h;(h=d.current)==null||h.click()},R=()=>x(null,null,function*(){try{l(null),z(null),o&&o(null)}catch(h){console.error("Erro ao remover avatar:",h),l("Erro ao remover foto")}});return e.jsxs("div",{className:"avatar-upload",children:[e.jsxs("div",{className:"avatar-preview",onClick:$,children:[r?e.jsx("img",{src:r,alt:"Avatar",className:"avatar-image"}):e.jsx("div",{className:"avatar-placeholder",children:e.jsx("span",{className:"material-icons",children:"account_circle"})}),b&&e.jsx("div",{className:"avatar-loading",children:e.jsx("div",{className:"spinner"})}),!b&&e.jsxs("div",{className:"avatar-overlay",children:[e.jsx("span",{className:"material-icons",children:"camera_alt"}),e.jsx("span",{className:"overlay-text",children:"Alterar foto"})]})]}),e.jsx("input",{ref:d,type:"file",accept:"image/*",onChange:n,className:"avatar-input",disabled:b}),e.jsxs("div",{className:"avatar-actions",children:[e.jsx("button",{type:"button",onClick:$,disabled:b,className:"btn-upload",children:b?"Enviando...":"Escolher Foto"}),r&&!b&&e.jsx("button",{type:"button",onClick:R,className:"btn-remove",children:"Remover"})]}),_&&e.jsx("div",{className:"avatar-progress",children:_}),E&&e.jsx("div",{className:"avatar-error",children:E}),e.jsx("p",{className:"avatar-hint",children:"JPG, PNG, WebP ou GIF. Sem limite de tamanho. Otimiza√ß√£o autom√°tica com seguran√ßa."})]})},ne=()=>{const{user:s,getUserProfile:o,updateProfile:t,logout:b}=D(),F=W(),[r,z]=f.useState(null),[E,l]=f.useState(!1),[_,j]=f.useState(!1),[d,k]=f.useState({full_name:"",bio:"",avatar_url:"",username:""}),[P,N]=f.useState(null),[n,$]=f.useState(null),[R,h]=f.useState(!1);f.useEffect(()=>{g(),i()},[]);const g=()=>x(null,null,function*(){try{const a=yield o();z(a),k({full_name:(a==null?void 0:a.full_name)||"",bio:(a==null?void 0:a.bio)||"",avatar_url:(a==null?void 0:a.avatar_url)||"",username:(a==null?void 0:a.username)||(s==null?void 0:s.username)||""})}catch(a){console.error("Error loading profile:",a)}}),i=()=>x(null,null,function*(){try{const{data:{session:a}}=yield U.auth.getSession();if(!(a!=null&&a.access_token))return;const c=yield fetch("http://localhost:3001/api/profile/username-status",{headers:{Authorization:`Bearer ${a.access_token}`}});if(c.ok){const m=yield c.json();$(m.data)}}catch(a){console.error("Error loading username status:",a)}}),u=a=>{k(G(q({},d),{[a.target.name]:a.target.value}))},w=a=>x(null,null,function*(){a.preventDefault(),j(!0),N(null);try{yield t({full_name:d.full_name,bio:d.bio}),yield g(),l(!1),N({type:"success",text:"Perfil atualizado com sucesso!"})}catch(p){N({type:"error",text:p.message||"Erro ao atualizar perfil"})}finally{j(!1)}}),y=()=>x(null,null,function*(){if(!(!d.username||d.username===(r==null?void 0:r.username))){h(!0),N(null);try{const{data:{session:a}}=yield U.auth.getSession();if(!(a!=null&&a.access_token))throw new Error("Sess√£o expirada");const c=yield fetch("http://localhost:3001/api/profile/username",{method:"PATCH",headers:{Authorization:`Bearer ${a.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({username:d.username})}),m=yield c.json();if(!c.ok)throw new Error(m.message||"Erro ao atualizar username");N({type:"success",text:`Username atualizado! Voc√™ pode alterar mais ${m.data.changesRemaining} vez(es) esta semana.`}),yield g(),yield i(),window.location.reload()}catch(a){N({type:"error",text:a.message})}finally{h(!1)}}}),v=()=>x(null,null,function*(){try{yield b(),F("/login")}catch(a){console.error("Logout error:",a)}});return e.jsxs("div",{className:"profile-page",children:[e.jsx(X,{}),e.jsxs("div",{className:"profile-content",children:[e.jsxs(Z,{children:[e.jsxs("div",{className:"profile-header",children:[e.jsx("h1",{className:"profile-title",children:"Meu Perfil"}),e.jsx("div",{className:"profile-actions",children:E?e.jsx("button",{onClick:()=>{l(!1),k({full_name:(r==null?void 0:r.full_name)||"",bio:(r==null?void 0:r.bio)||"",avatar_url:(r==null?void 0:r.avatar_url)||""})},className:"btn-cancel",children:"Cancelar"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>l(!0),className:"btn-edit",children:"Editar Perfil"}),e.jsx("button",{onClick:v,className:"btn-logout",children:"Sair"})]})})]}),P&&e.jsx("div",{className:`profile-message ${P.type}`,children:P.text}),E?e.jsxs("form",{onSubmit:w,className:"profile-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"username",className:"form-label",children:["Username",n&&e.jsxs("span",{className:"username-limit-badge",children:[n.changesRemaining," altera√ß√£o(√µes) restante(s) esta semana"]})]}),e.jsxs("div",{className:"username-input-group",children:[e.jsx("input",{type:"text",id:"username",name:"username",value:d.username,onChange:u,className:"form-input",placeholder:"seu_username",pattern:"[a-zA-Z0-9_]{3,20}",title:"3-20 caracteres: letras, n√∫meros e underscore",disabled:!(n!=null&&n.canChange)||R}),d.username!==(r==null?void 0:r.username)&&(n==null?void 0:n.canChange)&&e.jsx("button",{type:"button",onClick:y,disabled:R,className:"btn-update-username",children:R?"...":"‚úì"})]}),!(n!=null&&n.canChange)&&e.jsxs("p",{className:"form-hint error",children:["Voc√™ atingiu o limite de 2 altera√ß√µes por semana.",(n==null?void 0:n.lastChange)&&` Pr√≥xima altera√ß√£o dispon√≠vel em ${Math.ceil(7-Math.floor((Date.now()-new Date(n.lastChange).getTime())/(1e3*60*60*24)))} dias.`]}),e.jsx("p",{className:"form-hint",children:"3-20 caracteres. Apenas letras, n√∫meros e underscore (_)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"full_name",className:"form-label",children:"Nome Completo"}),e.jsx("input",{type:"text",id:"full_name",name:"full_name",value:d.full_name,onChange:u,className:"form-input",placeholder:"Seu nome completo"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"bio",className:"form-label",children:"Bio"}),e.jsx("textarea",{id:"bio",name:"bio",value:d.bio,onChange:u,className:"form-textarea",placeholder:"Conte um pouco sobre voc√™...",rows:"4"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Foto de Perfil"}),e.jsx(Y,{currentAvatar:d.avatar_url,onUploadSuccess:a=>x(null,null,function*(){k(G(q({},d),{avatar_url:a}));try{const{error:p}=yield U.from("users").update({avatar_url:a}).eq("id",s.id);if(p)throw p;N({type:"success",text:"Foto atualizada com sucesso!"}),yield g()}catch(p){console.error("Erro ao atualizar avatar:",p),N({type:"error",text:"Erro ao salvar foto"})}})})]}),e.jsx("button",{type:"submit",disabled:_,className:"btn-save",children:_?"Salvando...":"Salvar Altera√ß√µes"})]}):e.jsxs("div",{className:"profile-view",children:[e.jsx("div",{className:"profile-avatar-section",children:s!=null&&s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:"Avatar",className:"profile-avatar-large"}):e.jsx("div",{className:"profile-avatar-placeholder",children:e.jsx("span",{className:"material-icons",children:"account_circle"})})}),e.jsxs("div",{className:"profile-field",children:[e.jsx("label",{className:"profile-label",children:"Username"}),e.jsx("p",{className:"profile-value",children:s==null?void 0:s.username})]}),e.jsxs("div",{className:"profile-field",children:[e.jsx("label",{className:"profile-label",children:"Email"}),e.jsx("p",{className:"profile-value",children:s==null?void 0:s.email})]}),e.jsxs("div",{className:"profile-field",children:[e.jsx("label",{className:"profile-label",children:"Nome Completo"}),e.jsx("p",{className:"profile-value",children:(r==null?void 0:r.full_name)||"N√£o informado"})]}),e.jsxs("div",{className:"profile-field",children:[e.jsx("label",{className:"profile-label",children:"Bio"}),e.jsx("p",{className:"profile-value",children:(r==null?void 0:r.bio)||"Nenhuma bio adicionada"})]})]})]}),e.jsx(Q,{})]})]})};export{ne as default};
